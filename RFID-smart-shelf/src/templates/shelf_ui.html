<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shelf UI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fff;
        }
        .main-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .shelf-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 60px;
            width: 100%;
            height: 100%;
            padding: 24px;
            box-sizing: border-box;
            transition: background-color 0.3s, flex-direction 0.3s;
        }

        .queue-drawer { position: fixed; top: 0; left: 0; width: 410px; max-width: 100vw; height: 100vh; background: #fff; box-shadow: 4px 0 24px rgba(0,0,0,0.13); z-index: 100; padding: 32px; transition: transform 0.33s cubic-bezier(.55,0,.32,1); transform: translateX(-100%); display: flex; flex-direction: column; }
        .queue-drawer.open { transform: translateX(0); }
        .queue-header { font-size: 2em; font-weight: 700; margin-bottom: 16px; margin-top: 0; }
        .queue-list { flex: 1; overflow-y: auto; margin: 0; padding: 0; list-style: none; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 0 12px 0; border-bottom: 1px solid #eee; gap: 8px; }
        .queue-item-details { display: flex; flex-direction: column; line-height: 1.3; }
        .queue-lot-no { font-weight: 600; font-size: 1.1em; }
        .queue-emp-id { font-size: 14px; color: #6c757d; }
        .queue-item button { font-size: 15px; padding: 6px 22px; cursor: pointer; background-color: #198754; color: white; border: none; border-radius: 6px; font-weight: 600; }
        .queue-placeholder { color: #6c757d; font-style: italic; margin-top: 20px; }
        .drawer-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.07); z-index: 50; display: none; }
        .drawer-backdrop.open { display: block; }
        .main-content.blurred { filter: blur(2px) grayscale(0.3); }
        .details-panel { display: flex; flex-direction: column; gap: 16px; min-width: 270px; }
        .details-panel .label { font-size: 21px; color: #6c757d; }
        .details-panel .value { font-size: 26px; font-weight: 600; color: #343a40; }
        .details-panel .lot-no { font-size: 62px; font-weight: 800; }
        .status-badge { background-color: #6c757d; color: white; padding: 8px 28px; border-radius: 24px; font-weight: 700; font-size: 1.45em; display: inline-block; }
        .status-badge.Waiting { background-color: #0d6efd; }
        .status-badge.Error { background-color: #dc3545; }
        .shelf-panel h2 { font-size: 2em; color: #343a40; margin: 0 0 20px 0; text-align: center; }
        .shelf-grid { display: grid; grid-template-rows: repeat(4, 60px); grid-template-columns: repeat(6, 60px); gap: 7px; padding: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6; }
        .shelf-frame { border: 10px solid #adb5bd; border-radius: 10px; padding: 6px; }
        .shelf-cell { background-color: #fff; border: 1.8px solid #e9ecef; border-radius: 4px; transition: background .18s; }
        .shelf-cell.has-item { background-color: #adb5bd; border-color: #6c757d; }
        .shelf-cell.selected-task { background-color: #22c55e !important; border-color: #15803d !important; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        .shelf-cell.wrong-location {
            background-color: #dc3545 !important; /* ‡πÅ‡∏î‡∏á */
            border-color: #b02a37 !important;
            box-shadow: 0 0 10px #dc3545;
        }
        .back-to-queue-btn { background: none; border: none; color: #0d6efd; cursor: pointer; font-size: 16px; padding: 8px; margin-top: 20px; text-align: center; width: 100%; }
        .back-to-queue-btn:hover { text-decoration: underline; }
        .shelf-container.error-state { background-color: #fff1f2; }
        .shelf-cell.highlight-error { animation: blink-error 1.2s infinite ease-in-out; }
        @keyframes blink-error { 
            0%   { background-color: #22c55e; }   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
            50%  { background-color: #15803d; }   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° */
            100% { background-color: #22c55e; }   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
}
        
     

        .shelf-container.full-shelf-mode {
            justify-content: center;
            align-items: center;
        }
        .shelf-container.full-shelf-mode .shelf-panel h2 {
            font-size: 2.5em;
        }
        .shelf-container.full-shelf-mode .shelf-grid {
            grid-template-rows: repeat(4, 130px);
            grid-template-columns: repeat(6, 130px);
            gap: 15px;
        }
        .shelf-container.full-shelf-mode .shelf-frame {
            border-width: 15px;
        }

        @media (max-width: 1300px) {
            body { font-size: 14px; }
            .shelf-container { gap: 30px; }
            .details-panel { gap: 12px; min-width: 230px; }
            .details-panel .label { font-size: 18px; }
            .details-panel .value { font-size: 20px; }
            .details-panel .lot-no { font-size: 48px; }
            .status-badge { font-size: 1.25em; padding: 6px 20px; }
            .shelf-panel h2 { font-size: 1.6em; margin-bottom: 15px; }
            .shelf-grid {
                grid-template-rows: repeat(4, 50px);
                grid-template-columns: repeat(6, 50px);
                gap: 5px;
            }
            .shelf-frame { border-width: 8px; padding: 5px; }
            .queue-drawer { width: 350px; padding: 24px; }
            .queue-header { font-size: 1.8em; }
            .queue-item { padding: 14px 0 10px 0; }
            .queue-item button { font-size: 14px; padding: 5px 18px; }

            .shelf-container.full-shelf-mode .shelf-panel h2 {
                font-size: 2.2em;
            }
            .shelf-container.full-shelf-mode .shelf-grid {
                grid-template-rows: repeat(4, 100px);
                grid-template-columns: repeat(6, 100px);
                gap: 10px;
            }
            .shelf-container.full-shelf-mode .shelf-frame {
                border-width: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <aside class="queue-drawer" id="queueDrawer">
        <div class="queue-header">Job Queue</div>
        <ul class="queue-list" id="queueList"></ul>
    </aside>

    <main class="main-content" id="mainContent">
        <div class="shelf-container" id="shelfContainer" style="display:none;">
            <div class="details-panel" id="detailsPanel"></div>
            <div class="shelf-panel" id="shelfPanel">
                <h2>Shelf</h2>
                <div class="shelf-frame"><div class="shelf-grid" id="shelfGrid"></div></div>
            </div>
        </div>
    </main>

    <script>
        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const queueDrawer = document.getElementById('queueDrawer');
        const queueListEl = document.getElementById('queueList');
        const detailsPanel = document.getElementById('detailsPanel');
        const shelfGrid = document.getElementById('shelfGrid');
        const shelfContainer = document.getElementById('shelfContainer');

        const ROWS = 4, COLS = 6;
        const GLOBAL_SHELF_STATE_KEY = 'globalShelfState';

        function openDrawer() { queueDrawer.classList.add('open'); drawerBackdrop.classList.add('open'); document.getElementById('mainContent').classList.add('blurred'); }
        function closeDrawer() { queueDrawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); document.getElementById('mainContent').classList.remove('blurred'); }
        drawerBackdrop.onclick = closeDrawer;

        for (let r = 1; r <= ROWS; r++) for (let c = 1; c <= COLS; c++) {
            const cell = document.createElement('div');
            cell.classList.add('shelf-cell');
            cell.id = `cell-${r}-${c}`;
            shelfGrid.appendChild(cell);
        }

        function getActiveJob() { return JSON.parse(localStorage.getItem('activeShelfJob') || 'null'); }
        function setActiveJob(job) { localStorage.setItem('activeShelfJob', JSON.stringify(job)); }
        
        function renderShelfFromState(shelfState) {
            document.querySelectorAll('.shelf-cell').forEach(c => c.className = 'shelf-cell');
            if (Array.isArray(shelfState)) {
                shelfState.forEach(([level, block, hasItem]) => { // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    if (hasItem > 0) {
                        const cell = document.getElementById(`cell-${level}-${block}`);
                        if (cell) cell.classList.add('has-item');
                    }
                });
            }
        }

        function renderQueueList() {
            const queue = cleanInvalidJobs(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
            console.log('renderQueueList - Cleaned Queue:', queue);
            
            queueListEl.innerHTML = '';
            
            if (queue.length === 0) {
                queueListEl.innerHTML = '<li class="queue-placeholder">No jobs in queue...</li>';
                closeDrawer();
                return;
            }

            // *** START: ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1 ***
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ index ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô
            queue.forEach((job, index) => {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö job ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!job || !job.lot_no) {
                    console.warn('Invalid job at index', index, ':', job);
                    return; // ‡∏Ç‡πâ‡∏≤‡∏° job ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                }
                
                const item = document.createElement('li');
                item.className = 'queue-item';
                item.innerHTML = `
                    <div class="queue-item-details">
                        <span class="queue-lot-no">Lot: ${job.lot_no}</span>
                        <span class="queue-emp-id">Action: ${job.place_flg === "1" ? "Place" : "Pick"} at L:${job.level}, B:${job.block}</span>
                    </div>
                    <button data-job-index="${index}">Select</button>
                `;
                queueListEl.appendChild(item);
            });
            // *** END: ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1 ***

            if (queue.length > 1 && !getActiveJob()) {
                openDrawer();
            } else {
                closeDrawer();
            }
        }

        function goBackToQueue() {
            localStorage.removeItem('activeShelfJob');
            renderAll();
        }

        function renderActiveJob() {
            const activeJob = getActiveJob();
            
            // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            console.log('Active Job:', activeJob);
            const currentShelfState = JSON.parse(localStorage.getItem(GLOBAL_SHELF_STATE_KEY) || '[]');
            console.log('Shelf State:', currentShelfState);
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å container ‡πÅ‡∏•‡∏∞ cell ‡∏Å‡πà‡∏≠‡∏ô
            shelfContainer.classList.remove('error-state', 'full-shelf-mode');
            document.querySelectorAll('.shelf-cell').forEach(c => c.className = 'shelf-cell');

            if (!activeJob || !activeJob.lot_no) {
                // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠ job ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ---
                if (activeJob && !activeJob.lot_no) {
                    console.warn('Invalid active job detected, clearing...', activeJob);
                    localStorage.removeItem('activeShelfJob');
                }
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°)
                shelfContainer.classList.add('full-shelf-mode');
                detailsPanel.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô panel ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                renderShelfFromState(currentShelfState); // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
                return;
            }
            
            // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà ---
            // ‡πÅ‡∏™‡∏î‡∏á panel ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
            detailsPanel.style.display = 'flex';

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ place_flg ‡πÅ‡∏•‡∏∞ trn_status ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const actionText = activeJob.place_flg === "1" ? "Place To" : "Pick From";
            const statusText = activeJob.trn_status === "3" || activeJob.trn_status === "Error" ? "Error" : "Waiting";
            const statusClass = activeJob.trn_status === "3" || activeJob.trn_status === "Error" ? "Error" : "Waiting";

            detailsPanel.innerHTML = `
                <div><span class="label">Status  </span><span class="value"><span class="status-badge ${statusClass}">${statusText}</span></span></div>
                <div><span class="label">Lot No.</span><span class="value lot-no">${activeJob.lot_no}</span></div>
                <div><span class="label">${actionText}</span><span class="value">L: ${activeJob.level}, B: ${activeJob.block}</span></div>
                <div><span class="label">Time Stamp </span><span class="value">${activeJob.timestamp}</span></div>
                <button class="back-to-queue-btn" onclick="goBackToQueue()">‚Üê Back to Queue</button>
            `;
            
            if (activeJob.error) {
                shelfContainer.classList.add('error-state');
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏ß‡∏≤‡∏á/‡∏´‡∏¢‡∏¥‡∏ö)
            if (activeJob.level !== undefined && activeJob.block !== undefined) {
                const { level, block } = activeJob;
                const targetCell = document.getElementById(`cell-${level}-${block}`);
                if (targetCell) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥
                    targetCell.classList.add(activeJob.error ? 'highlight-error' : 'selected-task');
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏ú‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
            if (activeJob.error && activeJob.errorLocation) {
                const { level, block } = activeJob.errorLocation;
                const wrongCell = document.getElementById(`cell-${level}-${block}`);
                if (wrongCell) {
                    wrongCell.classList.add('wrong-location');
                }
            }
        }

        // *** START: ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 2 ***
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Event Listener ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö job-index ‡πÅ‡∏ó‡∏ô job-id
        queueListEl.addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.jobIndex) {
                const jobIndex = parseInt(event.target.dataset.jobIndex, 10);
                const queue = cleanInvalidJobs(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô Array (‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
                const selectedJob = queue[jobIndex];
                if (selectedJob && selectedJob.lot_no) {
                    setActiveJob(selectedJob);
                    renderAll(); 
                    closeDrawer();
                } else {
                    console.error('Invalid job selected:', selectedJob);
                }
            }
        });
        // *** END: ‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 2 ***

        function renderAll() {
            shelfContainer.style.display = 'flex';
            const queue = cleanInvalidJobs(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á active job ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
            if (queue.length > 1 && getActiveJob()) {
                const activeJobInQueue = queue.some(job => JSON.stringify(job) === JSON.stringify(getActiveJob()));
                // ‡∏ñ‡πâ‡∏≤ active job ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏≤‡∏à‡∏≤‡∏Å auto-select)
                // ‡∏Å‡∏≤‡∏£‡∏•‡∏ö activeJob ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç !getActiveJob() ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞ drawer ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î
                // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏ö active job ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏ß‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ active job ‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ auto-select
                // ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏Å‡πá‡∏ï‡∏≤‡∏° ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ auto-select ‡∏ô‡∏±‡πâ‡∏ô‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
                // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏¥‡∏ß
                // `goBackToQueue` ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            } else if (queue.length === 1 && !getActiveJob()) {
                setActiveJob(queue[0]);
            }

            renderQueueList();
            renderActiveJob();
        }

        window.addEventListener('storage', (event) => {
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 1 ‡πÄ‡∏õ‡πá‡∏ô 2 (‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤) ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á Active Job ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
            if (event.key === 'shelfQueue') {
                const oldQueue = JSON.parse(event.oldValue || '[]');
                const newQueue = JSON.parse(event.newValue || '[]');
                if (oldQueue.length === 1 && newQueue.length > 1) {
                    localStorage.removeItem('activeShelfJob');
                }
            }
            renderAll();
        });
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
        function cleanInvalidJobs() {
            try {
                const queue = JSON.parse(localStorage.getItem('shelfQueue') || '[]');
                const validQueue = queue.filter(job => {
                    return job && 
                           typeof job === 'object' && 
                           job.lot_no && 
                           job.level && 
                           job.block && 
                           job.place_flg !== undefined;
                });
                
                if (validQueue.length !== queue.length) {
                    console.log('Cleaned invalid jobs. Before:', queue.length, 'After:', validQueue.length);
                    localStorage.setItem('shelfQueue', JSON.stringify(validQueue));
                }
                
                return validQueue;
            } catch (e) {
                console.error('Error cleaning jobs:', e);
                localStorage.removeItem('shelfQueue');
                return [];
            }
        }

        // üîç Debug Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π localStorage
        function debugLocalStorage() {
            console.group('üì¶ Local Storage Debug');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            const queue = JSON.parse(localStorage.getItem('shelfQueue') || '[]');
            const activeJob = JSON.parse(localStorage.getItem('activeShelfJob') || 'null');
            const shelfState = JSON.parse(localStorage.getItem('globalShelfState') || '[]');
            
            console.log('üî¢ Queue Jobs:', queue.length, queue);
            console.log('‚ö° Active Job:', activeJob);
            console.log('üìã Shelf State:', shelfState.length + ' positions', shelfState);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            if (queue.length > 0) {
                console.table(queue);
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• localStorage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            console.log('üóÇÔ∏è All localStorage:', localStorage);
            console.log('üìä Total size:', JSON.stringify(localStorage).length + ' characters');
            
            console.groupEnd();
        }

        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Console ‡πÑ‡∏î‡πâ
        window.debugLocalStorage = debugLocalStorage;

        cleanInvalidJobs();
        renderAll();
    </script>
</body>
</html>