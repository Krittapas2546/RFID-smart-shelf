<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shelf UI</title>
    <!-- 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå CSS ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
    <link rel="stylesheet" href="/static/css/ui_styles.css">
    <style>
      .arrow {
        width: 0;
        height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
      }
      .arrow.up {
        border-bottom: 18px solid #3498db;
        animation: bounce-up 1s infinite;
      }
      .arrow.down {
        border-top: 18px solid #2ecc71;
        animation: bounce-down 1s infinite;
      }
      @keyframes bounce-up {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-6px); }
      }
      @keyframes bounce-down {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(6px); }
      }
      .queue-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 18px 24px;
        margin-bottom: 18px;
        min-height: 56px;
      }
      .queue-list-item .info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .queue-list-item .lot {
        font-size: 1.15em;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .queue-list-item .action {
        font-size: 0.98em;
        color: #666;
        margin-left: 2px;
      }
      .select-btn {
        background: #27ae60;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 22px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .select-btn:hover {
        background: #219150;
      }
    </style>
</head>
<body>
    <!-- 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• -->

    <!-- View 1: ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß -->
    <div id="queueSelectionView" style="display: none;">
        <h2>Job Queue</h2>

        <!-- üîΩ ADD THIS ENTIRE BLOCK üîΩ -->
        <div class="barcode-scanner-container">
            <input type="text" id="lot-no-input" placeholder="üîç Ready for Barcode Scanner - Scan or type Lot No.">
            <button onclick="handleLotSearch()">Find Job</button>
        </div>
        <!-- üîº END OF ADDED BLOCK üîº -->

        <ul id="queueListContainer">
            <!-- Job items will be injected here by JavaScript -->
        </ul>
    </div>

    <!-- View 2: ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Active Job) -->
    <main id="mainView" style="display: none;">
        <!-- üîΩ ADD HIDDEN INPUT FOR BARCODE SCANNER üîΩ -->
        <input type="text" id="barcode-scanner-input" style="position: absolute; left: -9999px; opacity: 0;" placeholder="Barcode Scanner Input">
        <!-- üîº END OF ADDED INPUT üîº -->
        
        <div class="shelf-container" id="shelfContainer">
            <div class="details-panel" id="detailsPanel">
                <!-- JavaScript ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
            <div class="shelf-panel" id="shelfPanel">
                <div style="display: flex; align-items: flex-start; gap: 32px;">
                  <div id="cellPreviewLegend" style="min-width: 240px; max-width: 300px;">
                    <!-- Cell Preview will be rendered here by JS -->
                  </div>
                  <div style="flex: 1;">
                    <h2>Shelf</h2>
                    <div class="shelf-frame"><div class="shelf-grid" id="shelfGrid"></div></div>
                  </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå JavaScript ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (‡∏Ñ‡∏ß‡∏£‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢ body) -->
    <script src="/static/js/ui_logic.js"></script>
    <style>
      .cell-preview-box {
        height: 240px; width: 120px; border: 2px solid #222; border-radius: 8px;
        margin: auto; background: #fafbfc; display: flex; flex-direction: column; overflow: hidden;
        position: relative;
      }
      .cell-preview-title {
        text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;
      }
      .cell-preview-lot {
        display: flex; align-items: center; justify-content: center; font-size: 1.08em; border-bottom: 1px solid #bbb;
        color: #222; background: #fff; font-weight: 500;
      }
      .cell-preview-lot.target {
        background: repeating-linear-gradient(135deg, #e6f2ff, #e6f2ff 8px, #cce6ff 12px, #e6f2ff 16px);
        border-bottom: 2px solid #3498db; border-left: 4px solid #3498db; font-weight: bold;
      }
      .cell-preview-lot .count {
        font-size: 0.95em; color: #888; margin-left: 6px;
      }
      .cell-preview-empty {
        background: #e0e0e0; color: #888; display: flex; align-items: center; justify-content: center; font-size: 1.05em; border-bottom: 1px solid #bbb;
      }
      .cell-preview-scale { display: flex; justify-content: space-between; font-size: 0.95em; margin-top: 8px; }
      .cell-preview-arrow { position: absolute; left: -32px; top: 0; bottom: 0; display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 100%; }
      .cell-preview-arrow .arrow-label { font-size: 1.1em; color: #222; }
      .cell-preview-arrow .arrow-v { width: 2px; height: 100px; background: #222; margin: 0 0 0 0; }
    </style>
    <script>
      // Render cell preview for selected job
      function renderCellPreview({level, block, lots, targetLotNo}) {
        const maxTray = 24;
        let totalTray = 0;
        let html = '';
        // lots: array of {lot_no, tray_count}
        if (!Array.isArray(lots)) lots = [];
        // Sum tray_count
        totalTray = lots.reduce((sum, l) => sum + (parseInt(l.tray_count)||0), 0);
        // Build stacked lots (bottom-up)
        let stackHtml = '';
        let emptyTop = maxTray - totalTray;
        if (emptyTop > 0) {
          stackHtml += `<div class='cell-preview-empty' style='height:${(emptyTop/maxTray)*100}%;'>(empty)</div>`;
        }
        // Render each lot (bottom-up)
        for (let i = lots.length-1; i >= 0; i--) {
          const lot = lots[i];
          const h = ((parseInt(lot.tray_count)||0)/maxTray)*100;
          const isTarget = lot.lot_no === targetLotNo;
          stackHtml += `<div class='cell-preview-lot${isTarget ? ' target' : ''}' style='height:${h}%;'>${lot.lot_no} <span class='count'>${lot.tray_count}</span></div>`;
        }
        if (totalTray === 0) {
          stackHtml = `<div class='cell-preview-empty' style='height:100%'>(empty)</div>`;
        }
        html += `<div class='cell-preview-title'>Level ${level} Block ${block}</div>`;
        html += `<div style='position:relative;'>`;
        html += `<div class='cell-preview-box'>${stackHtml}</div>`;
        // Arrow and scale
        html += `<div class='cell-preview-arrow' style='left:-38px;top:0;bottom:0;'><span class='arrow-label'>24</span><div class='arrow-v'></div><span class='arrow-label'>6</span></div>`;
        html += `</div>`;
        html += `<div class='cell-preview-scale'><span>24</span><span>12</span><span>8</span><span>2</span></div>`;
        // Legend
        html += `<div style='display:flex;flex-direction:column;gap:10px;margin-top:18px;'>`;
        html += `<div style='display:flex;align-items:center;gap:10px;'><div style='width:28px;height:18px;background:#e6f2ff;border-radius:3px;border:1.5px solid #3498db;'></div> <span style='font-size:1em;'>Lot ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ü‡πâ‡∏≤)</span></div>`;
        html += `<div style='display:flex;align-items:center;gap:10px;'><div style='width:28px;height:18px;background:#fff;border-radius:3px;border:1.5px solid #bbb;'></div> <span style='font-size:1em;'>Lot ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á (‡∏Ç‡∏≤‡∏ß)</span></div>`;
        html += `</div>`;
        document.getElementById('cellPreviewLegend').innerHTML = html;
      }
      // Example usage: (replace with real data after job select)
      // renderCellPreview({level:1, block:3, lots:[{lot_no:'test_1',tray_count:6},{lot_no:'test_2',tray_count:6},{lot_no:'test_3',tray_count:6}], targetLotNo:'test_2'});
    </script>
    <script>
      // ‡∏õ‡∏£‡∏±‡∏ö renderQueueSelectionView: ‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Lot, ‡πÑ‡∏°‡πà‡∏°‡∏µ label Pick/Place, ‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î
      window.renderQueueSelectionView = function(queue) {
        const queueListContainer = document.getElementById('queueListContainer');
        queueListContainer.innerHTML = '';
        queue.forEach(job => {
          const li = document.createElement('li');
          li.className = 'queue-list-item';
          // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å icon ‡∏ï‡∏≤‡∏° action
          let arrowHtml = '';
          if (job.place_flg === '0') {
            arrowHtml = `<span class="arrow up"></span>`;
          } else {
            arrowHtml = `<span class="arrow down"></span>`;
          }
          li.innerHTML = `
            <div class="info">
              <div class="lot">${arrowHtml}Lot: ${job.lot_no}</div>
              <div class="action">Action: ${job.place_flg === '1' ? 'Place' : 'Pick'} at L:${job.level}, B:${job.block}</div>
            </div>
            <button class="select-btn" onclick="selectJob('${job.jobId}')">Select</button>
          `;
          queueListContainer.appendChild(li);
        });

        // Logic focus ‡πÄ‡∏î‡∏¥‡∏°
        const lotInput = document.getElementById('lot-no-input');
        if (lotInput) {
          lotInput.focus();
          lotInput.onkeyup = function(event) {
            if (event.key === 'Enter') {
              handleLotSearch();
            }
          };
        }
      };
    </script>


</html></body></body>
</html>