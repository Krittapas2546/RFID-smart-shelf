<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shelf UI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: flex-start; height: 100vh; margin: 0; background-color: #f0f2f5; padding-top: 40px; }
        .layout-container { display: flex; gap: 40px; }
        .main-container { display: flex; align-items: center; gap: 40px; padding: 30px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: background-color 0.3s ease; }
        /* --- >> CSS ใหม่สำหรับสถานะ Error << --- */
        .main-container.error-state { background-color: #fff2f2; }
        .details-panel { display: flex; flex-direction: column; gap: 16px; min-width: 220px; }
        .details-panel .label { font-size: 16px; color: #6c757d; }
        .details-panel .value { font-size: 20px; font-weight: 600; color: #343a40; }
        .details-panel .lot-no { font-size: 48px; font-weight: 700; line-height: 1.1; }
        .status-badge { background-color: #6c757d; color: white; padding: 6px 16px; border-radius: 16px; font-weight: 600; }
        .status-badge.Waiting { background-color: #0d6efd; }
        .status-badge.Error { background-color: #dc3545; } /* <<-- CSS ใหม่สำหรับป้าย Error */
        .shelf-panel h2 { font-size: 20px; color: #343a40; margin: 0 0 10px 0; text-align: center; }
        .shelf-grid { display: grid; grid-template-rows: repeat(4, 50px); grid-template-columns: repeat(6, 50px); gap: 5px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; }
        .shelf-frame { border: 10px solid #adb5bd; border-radius: 5px; padding: 5px; }
        .shelf-cell { background-color: #fff; border: 1px solid #e9ecef; border-radius: 2px; }
        .highlight-active { background-color: #dc3545; }
        /* --- >> CSS ใหม่สำหรับ Highlight Error << --- */
        .highlight-error { background-color: #ffc107; animation: blink-animation 1s infinite; }
        @keyframes blink-animation { 50% { background-color: #f8d7da; } }
        .queue-panel { padding: 30px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); width: 280px; }
        .queue-panel h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .queue-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .queue-item-details { display: flex; flex-direction: column; }
        .queue-lot-no { font-weight: 600; }
        .queue-emp-id { font-size: 12px; color: #6c757d; }
        .queue-item button { font-size: 14px; padding: 5px 10px; cursor: pointer; background-color: #198754; color: white; border: none; border-radius: 4px; }
        .placeholder { color: #6c757d; font-style: italic; padding: 10px; }
    </style>
</head>
<body>
    <div class="layout-container">
        <div class="queue-panel">
            <h2>Job Queue</h2>
            <ul class="queue-list" id="queueList"></ul>
        </div>
        <div class="main-container" id="mainContainer">
            <div class="details-panel" id="detailsPanel">
                <div class="placeholder" id="mainPlaceholder">Please select a job from the queue</div>
                <div id="activeJobContent" style="display: none; flex-direction: column; gap: 16px;">
                    <div><span class="label">Status</span><span class="value"><span class="status-badge" id="status"></span></span></div>
                    <div><span class="label">Lot No.</span><span class="value lot-no" id="lot_no"></span></div>
                    <div><span class="label">Form</span><span class="value" id="from_shelf"></span></div>
                    <div><span class="label">Employee ID</span><span class="value" id="emp_id"></span></div>
                    <div><span class="label">Time Stamp</span><span class="value" id="timestamp"></span></div>
                </div>
            </div>
            <div class="shelf-panel">
                <h2>Shelf</h2>
                <div class="shelf-frame"><div class="shelf-grid" id="shelfGrid"></div></div>
            </div>
        </div>
    </div>

    <script>
        const queueListEl = document.getElementById('queueList');
        const shelfGrid = document.getElementById('shelfGrid');
        const mainContainer = document.getElementById('mainContainer');
        const mainPlaceholder = document.getElementById('mainPlaceholder');
        const activeJobContent = document.getElementById('activeJobContent');
        const ROWS = 4;
        const COLS = 6;

        for (let r = 1; r <= ROWS; r++) { for (let c = 1; c <= COLS; c++) { const cell = document.createElement('div'); cell.classList.add('shelf-cell'); cell.id = `cell-${r}-${c}`; shelfGrid.appendChild(cell); } }

        function renderQueue() {
            const queue = JSON.parse(localStorage.getItem('shelfQueue') || '[]');
            queueListEl.innerHTML = '';
            if (queue.length === 0) {
                queueListEl.innerHTML = '<li class="placeholder">No jobs in queue...</li>';
                return;
            }
            queue.forEach(job => {
                const item = document.createElement('li');
                item.className = 'queue-item';
                item.innerHTML = `
                    <div class="queue-item-details">
                        <span class="queue-lot-no">Lot: ${job.lotNo}</span>
                        <span class="queue-emp-id">Emp: ${job.employeeId}</span>
                    </div>
                    <button data-job-id="${job.jobId}">Select</button>
                `;
                queueListEl.appendChild(item);
            });
        }
        
        function renderActiveJob() {
            const activeJob = JSON.parse(localStorage.getItem('activeShelfJob') || 'null');
            // --- >> รีเซ็ตสถานะ Error ทุกครั้งที่วาดใหม่ << ---
            mainContainer.classList.remove('error-state');
            document.querySelectorAll('.shelf-cell').forEach(c => c.className = 'shelf-cell');

            if (!activeJob) {
                mainPlaceholder.style.display = 'block';
                activeJobContent.style.display = 'none';
                return;
            }
            
            mainPlaceholder.style.display = 'none';
            activeJobContent.style.display = 'flex';
            
            const statusEl = document.getElementById('status');
            statusEl.textContent = activeJob.status;
            statusEl.className = 'status-badge ' + activeJob.status.replace(' ', '');
            document.getElementById('lot_no').textContent = activeJob.lotNo;
            document.getElementById('from_shelf').textContent = activeJob.from;
            document.getElementById('emp_id').textContent = activeJob.employeeId;
            document.getElementById('timestamp').textContent = activeJob.timestamp;

            const targetCell = activeJob.location ? document.getElementById(`cell-${activeJob.location.row}-${activeJob.location.col}`) : null;

            // --- >> ตรวจสอบสถานะ Error เพื่อเปลี่ยนการแสดงผล << ---
            if (activeJob.error) {
                mainContainer.classList.add('error-state');
                if (targetCell) targetCell.classList.add('highlight-error');
            } else {
                if (targetCell) targetCell.classList.add('highlight-active');
            }
        }

        queueListEl.addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                const jobId = event.target.getAttribute('data-job-id');
                const queue = JSON.parse(localStorage.getItem('shelfQueue') || '[]');
                let selectedJob = queue.find(job => job.jobId === jobId);
                if (selectedJob) {
                    // ทำให้เป็น object ใหม่เพื่อป้องกันการแก้ไขที่กระทบกับในคิว
                    selectedJob = JSON.parse(JSON.stringify(selectedJob));
                    // รีเซ็ตสถานะ error เมื่อเลือกงานใหม่
                    selectedJob.error = null;
                    selectedJob.status = "Waiting";
                    localStorage.setItem('activeShelfJob', JSON.stringify(selectedJob));
                    renderActiveJob();
                }
            }
        });

        window.addEventListener('storage', function(event) {
            if (event.key === 'shelfQueue') renderQueue();
            if (event.key === 'activeShelfJob') renderActiveJob();
        });

        renderQueue();
        renderActiveJob();
    </script>
</body>
</html>