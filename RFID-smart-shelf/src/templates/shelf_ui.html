<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shelf UI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fff;
        }
        .main-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .shelf-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 60px;
            width: 100%;
            height: 100%;
            padding: 24px;
            box-sizing: border-box;
            transition: background-color 0.3s, flex-direction 0.3s;
        }

        .queue-drawer { position: fixed; top: 0; left: 0; width: 410px; max-width: 100vw; height: 100vh; background: #fff; box-shadow: 4px 0 24px rgba(0,0,0,0.13); z-index: 100; padding: 32px; transition: transform 0.33s cubic-bezier(.55,0,.32,1); transform: translateX(-100%); display: flex; flex-direction: column; }
        .queue-drawer.open { transform: translateX(0); }
        .queue-header { font-size: 2em; font-weight: 700; margin-bottom: 16px; margin-top: 0; }
        .queue-list { flex: 1; overflow-y: auto; margin: 0; padding: 0; list-style: none; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 0 12px 0; border-bottom: 1px solid #eee; gap: 8px; }
        .queue-item-details { display: flex; flex-direction: column; line-height: 1.3; }
        .queue-lot-no { font-weight: 600; font-size: 1.1em; }
        .queue-emp-id { font-size: 14px; color: #6c757d; }
        .queue-item button { font-size: 15px; padding: 6px 22px; cursor: pointer; background-color: #198754; color: white; border: none; border-radius: 6px; font-weight: 600; }
        .queue-placeholder { color: #6c757d; font-style: italic; margin-top: 20px; }
        .drawer-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.07); z-index: 50; display: none; }
        .drawer-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* --- START: Responsive Design for pi */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column; /* เปลี่ยนจากแนวนอนเป็นแนวตั้ง */
                padding: 15px;
            }

            .details-panel {
                width: 100%; /* ทำให้ Panel เต็มความกว้าง */
                margin-right: 0;
                margin-bottom: 20px; /* เพิ่มระยะห่างด้านล่าง */
                padding: 20px;
            }

            .details-panel .value.lot-no {
                font-size: 3rem; /* ลดขนาดฟอนต์ Lot No. */
            }

            .shelf-container {
                width: 100%;
            }

            .shelf-grid {
                gap: 5px; /* ลดช่องว่างระหว่าง Cell */
            }

            .shelf-cell {
                /* ทำให้ Cell มีขนาดเล็กลงและยืดหยุ่น */
                min-width: 40px;
                min-height: 40px;
                font-size: 0.8rem;
            }

            .queue-drawer {
                width: 90%; /* ทำให้ Drawer กว้างขึ้นบนมือถือ */
            }
        }
        /* --- END: Responsive Design for Mobile --- */

        /* --- START: สไตล์สำหรับหน้าเลือกงาน (Queue View) --- */
        #queueSelectionView {
            width: 100%;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .queue-view-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #343a40;
            text-align: center;
            margin-bottom: 30px;
        }
        #queueListContainer {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .queue-list-item {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .queue-list-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .queue-list-item .info .lot {
            font-size: 1.2rem;
            font-weight: 600;
            color: #212529;
        }
        .queue-list-item .info .action {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 4px;
        }
        .queue-list-item .select-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .queue-list-item .select-btn:hover {
            background-color: #218838;
        }
        /* --- END: สไตล์สำหรับหน้าเลือกงาน --- */

        .main-content.blurred { filter: blur(2px) grayscale(0.3); }
        .details-panel { display: flex; flex-direction: column; gap: 16px; min-width: 270px; }
        .details-panel .label { font-size: 21px; color: #6c757d; }
        .details-panel .value { font-size: 26px; font-weight: 600; color: #343a40; }
        .details-panel .lot-no { font-size: 62px; font-weight: 800; }
        .status-badge { background-color: #6c757d; color: white; padding: 8px 28px; border-radius: 24px; font-weight: 700; font-size: 1.45em; display: inline-block; }
        .status-badge.Waiting { background-color: #0d6efd; }
        .status-badge.Error { background-color: #dc3545; }
        .shelf-panel h2 { font-size: 2em; color: #343a40; margin: 0 0 20px 0; text-align: center; }
        .shelf-grid { display: grid; grid-template-rows: repeat(4, 60px); grid-template-columns: repeat(6, 60px); gap: 7px; padding: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6; }
        .shelf-frame { border: 10px solid #adb5bd; border-radius: 10px; padding: 6px; }
        .shelf-cell { background-color: #fff; border: 1.8px solid #e9ecef; border-radius: 4px; transition: background .18s; }
        .shelf-cell.has-item { background-color: #adb5bd; border-color: #6c757d; }
        .shelf-cell.selected-task { background-color: #0d6efd !important; border-color: #0d6efd !important; } 
        .shelf-cell.wrong-location {
            /* ลบ background-color และ box-shadow เก่าออก */
            border-color: #b02a37 !important;
            animation: blink-red-error 1.2s infinite ease-in-out; /* << เพิ่มอนิเมชัน */
        }
        .back-to-queue-btn { background: none; border: none; color: #0d6efd; cursor: pointer; font-size: 16px; padding: 8px; margin-top: 20px; text-align: center; width: 100%; }
        .back-to-queue-btn:hover { text-decoration: underline; }
        .shelf-container.error-state { background-color: #fff1f2; }
        .shelf-cell.highlight-error { animation: blink-error 1.2s infinite ease-in-out; }
        
        /* *** START: เพิ่ม Keyframes สำหรับกระพริบสีแดง *** */
        @keyframes blink-red-error {
            0%   { background-color: #dc3545; box-shadow: 0 0 10px #dc3545; }
            50%  { background-color: #fff; box-shadow: none; }
            100% { background-color: #dc3545; box-shadow: 0 0 10px #dc3545; }
        }
        /* *** END: เพิ่ม Keyframes สำหรับกระพริบสีแดง *** */

        @keyframes blink-error { 
            0%   { background-color: #22c55e; }   /* เขียว */
            50%  { background-color:rgb(255, 255, 255); }   /* ขาว */
            100% { background-color: #22c55e; }   /* เขียว */
        }

        /* *** START: เพิ่ม Style สำหรับ Notification *** */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 16px;
            font-weight: 600;
            animation: slide-in 0.5s forwards, slide-out 0.5s 2.5s forwards;
        }

        @keyframes slide-in {
            from { transform: translateX(120%); }
            to { transform: translateX(0); }
        }

        @keyframes slide-out {
            from { transform: translateX(0); }
            to { transform: translateX(120%); }
        }
        /* *** END: เพิ่ม Style สำหรับ Notification *** */
        
     

        .shelf-container.full-shelf-mode {
            justify-content: center;
            align-items: center;
        }
        .shelf-container.full-shelf-mode .shelf-panel h2 {
            font-size: 2.5em;
        }
        .shelf-container.full-shelf-mode .shelf-grid {
            grid-template-rows: repeat(4, 130px);
            grid-template-columns: repeat(6, 130px);
            gap: 15px;
        }
        .shelf-container.full-shelf-mode .shelf-frame {
            border-width: 15px;
        }

        @media (max-width: 1300px) {
            body { font-size: 14px; }
            .shelf-container { gap: 30px; }
            .details-panel { gap: 12px; min-width: 230px; }
            .details-panel .label { font-size: 18px; }
            .details-panel .value { font-size: 20px; }
            .details-panel .lot-no { font-size: 48px; } /* <-- ปรับขนาดฟอนต์ Lot No. ที่นี่ */
            .status-badge { font-size: 1.25em; padding: 6px 20px; }
            .shelf-panel h2 { font-size: 1.6em; margin-bottom: 15px; }
            .shelf-grid {
                /* ปรับขนาดช่อง Shelf Grid ทั้งหมดที่นี่ */
                grid-template-rows: repeat(4, 50px);
                grid-template-columns: repeat(6, 50px);
                gap: 5px;
            }
            .shelf-frame { border-width: 8px; padding: 5px; }
            .queue-drawer { width: 350px; padding: 24px; }
            .queue-header { font-size: 1.8em; }
            .queue-item { padding: 14px 0 10px 0; }
            .queue-item button { font-size: 14px; padding: 5px 18px; }

            .shelf-container.full-shelf-mode .shelf-panel h2 {
                font-size: 2.2em;
            }
            .shelf-container.full-shelf-mode .shelf-grid {
                grid-template-rows: repeat(4, 100px);
                grid-template-columns: repeat(6, 100px);
                gap: 10px;
            }
            .shelf-container.full-shelf-mode .shelf-frame {
                border-width: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- View 1: หน้าสำหรับเลือกงานจากคิว -->
    <div id="queueSelectionView" style="display: none;">
        <h1 class="queue-view-title">Job Queue</h1>
        <ul id="queueListContainer">
            <!-- JavaScript จะสร้างรายการ Job ที่นี่ -->
        </ul>
    </div>

    <!-- View 2: หน้าสำหรับทำงาน (Active Job) -->
    <main id="mainView" style="display: none;">
        <div class="shelf-container" id="shelfContainer">
            <div class="details-panel" id="detailsPanel">
                <!-- รายละเอียดงานที่กำลังทำ -->
            </div>
            <div class="shelf-panel" id="shelfPanel">
                <h2>Shelf</h2>
                <div class="shelf-frame"><div class="shelf-grid" id="shelfGrid"></div></div>
            </div>
        </div>
    </main>

    <script>
        // --- DOM Elements ---
        const queueSelectionView = document.getElementById('queueSelectionView');
        const queueListContainer = document.getElementById('queueListContainer');
        const mainView = document.getElementById('mainView');
        const detailsPanel = document.getElementById('detailsPanel');
        const shelfGrid = document.getElementById('shelfGrid');
        const shelfContainer = document.getElementById('shelfContainer');

        const ROWS = 4, COLS = 6;
        const GLOBAL_SHELF_STATE_KEY = 'globalShelfState';

        // *** START: เพิ่มฟังก์ชันที่หายไป ***
        function initializeShelfState() {
            if (!localStorage.getItem(GLOBAL_SHELF_STATE_KEY)) {
                const defaultState = [];
                for (let r = 1; r <= ROWS; r++) {
                    for (let c = 1; c <= COLS; c++) {
                        defaultState.push([r, c, 0]); // [level, block, hasItem]
                    }
                }
                localStorage.setItem(GLOBAL_SHELF_STATE_KEY, JSON.stringify(defaultState));
            }
        }

        function cleanInvalidJobs() {
            const queue = JSON.parse(localStorage.getItem('shelfQueue') || '[]');
            const cleanedQueue = queue.filter(job => job && job.lot_no && job.level && job.block);
            if (cleanedQueue.length !== queue.length) {
                console.warn("Removed invalid jobs from the queue.");
                localStorage.setItem('shelfQueue', JSON.stringify(cleanedQueue));
            }
            return cleanedQueue;
        }

        function getQueue() {
            return cleanInvalidJobs();
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // *** START: เพิ่มฟังก์ชันที่หายไป ***
        function getActiveJob() {
            return JSON.parse(localStorage.getItem('activeShelfJob') || 'null');
        }

        function setActiveJob(job) {
            localStorage.setItem('activeShelfJob', JSON.stringify(job));
        }

        function renderShelfGrid() {
            const shelfState = JSON.parse(localStorage.getItem(GLOBAL_SHELF_STATE_KEY) || '[]');
            const activeJob = getActiveJob();
            const isPlacing = activeJob && activeJob.place_flg === '1';

            shelfState.forEach(([level, block, hasItem]) => {
                const cell = document.getElementById(`cell-${level}-${block}`);
                if (!cell) return;

                cell.className = 'shelf-cell'; // Reset classes

                const isTaskLocation = activeJob && parseInt(activeJob.level) === level && parseInt(activeJob.block) === block;
                const isError = activeJob && activeJob.error;

                // --- START: Logic ใหม่ ---
                if (isError) {
                    // ถ้ามี Error: ให้ความสำคัญกับการแสดงผล Error ก่อน
                    const isErrorLocation = activeJob.errorLocation.level === level && activeJob.errorLocation.block === block;
                    if (isErrorLocation) {
                        // นี่คือช่องที่หยิบ/วางผิด -> ทำให้เป็นสีแดงกระพริบ
                        cell.classList.add('wrong-location');
                    } else if (isTaskLocation) {
                        // นี่คือช่องเป้าหมายเดิม -> ทำให้เป็นสีเทา (has-item) เพื่อแสดงว่ายังไม่ได้ทำ
                        cell.classList.add('has-item');
                    }
                } else {
                    // ถ้าไม่มี Error (สถานะปกติ):
                    if (isPlacing) {
                        if (isTaskLocation) cell.classList.add('selected-task');
                    } else {
                        if (hasItem) cell.classList.add('has-item');
                        if (isTaskLocation) cell.classList.add('selected-task');
                    }
                }
                // --- END: Logic ใหม่ ---
            });
        }

        function renderActiveJob() {
            const activeJob = getActiveJob();
            const queue = getQueue();
            detailsPanel.innerHTML = ''; // Clear previous details

            if (activeJob) {
                const statusText = activeJob.error ? 'Error' : 'Waiting';
                const statusClass = activeJob.error ? 'Error' : 'Waiting';
                const actionText = activeJob.place_flg === '1' ? 'Place To' : 'Pick From';
                
                detailsPanel.innerHTML = `
                    <div>
                        <div class="label">Status</div>
                        <div class="status-badge ${statusClass}">${statusText}</div>
                    </div>
                    <div>
                        <div class="label">Lot No.</div>
                        <div class="value lot-no">${activeJob.lot_no}</div>
                    </div>
                    <div>
                        <div class="label">${actionText}</div>
                        <div class="value">Level: ${activeJob.level}, Block: ${activeJob.block}</div>
                    </div>
                `;
                if (queue.length > 0) {
                    detailsPanel.innerHTML += `<button class="back-to-queue-btn" onclick="goBackToQueue()">← Back to Queue</button>`;
                }
            } else {
                detailsPanel.innerHTML = `
                    <div>
                        <div class="label">Status</div>
                        <div class="status-badge">Idle</div>
                    </div>
                    <div class="value" style="font-size: 1.5rem; color: #6c757d;">No active job.</div>
                `;
            }
            renderShelfGrid(); // อัปเดต Shelf Grid ทุกครั้งที่ Active Job เปลี่ยน
        }
        // *** END: เพิ่มฟังก์ชันที่หายไป ***

        function renderQueueSelectionView(queue) {
            queueListContainer.innerHTML = '';
            queue.forEach(job => {
                const li = document.createElement('li');
                li.className = 'queue-list-item';
                li.innerHTML = `
                    <div class="info">
                        <div class="lot">Lot: ${job.lot_no}</div>
                        <div class="action">Action: ${job.place_flg === '1' ? 'Place' : 'Pick'} at L:${job.level}, B:${job.block}</div>
                    </div>
                    <button class="select-btn" onclick="selectJob('${job.jobId}')">Select</button>
                `;
                queueListContainer.appendChild(li);
            });
        }

        function selectJob(jobId) {
            const queue = getQueue();
            const selectedJob = queue.find(job => job.jobId === jobId);
            if (selectedJob) {
                setActiveJob(selectedJob);
                renderAll();
            }
        }

        function goBackToQueue() {
            localStorage.removeItem('activeShelfJob');
            renderAll();
        }

        function renderAll() {
            const queue = getQueue();
            const activeJob = getActiveJob();

            // Logic ในการสลับ View
            if (queue.length > 0 && !activeJob) {
                // State 1: มีงานในคิว แต่ยังไม่ได้เลือก -> แสดงหน้าเลือกงาน
                mainView.style.display = 'none';
                queueSelectionView.style.display = 'block';
                renderQueueSelectionView(queue);
            } else {
                // State 2: มีงานที่กำลังทำอยู่ หรือไม่มีงานเลย -> แสดงหน้าทำงานหลัก
                queueSelectionView.style.display = 'none';
                mainView.style.display = 'flex';
                renderActiveJob(); // ฟังก์ชันนี้จะจัดการทั้งตอนมี activeJob และไม่มี
                renderShelfGrid(); // เพิ่มการเรียกตรงนี้เพื่อให้แน่ใจว่า Grid ถูกวาดเสมอ
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // สร้าง grid cell ไว้ล่วงหน้า
            for (let r = 1; r <= ROWS; r++) for (let c = 1; c <= COLS; c++) {
                const cell = document.createElement('div');
                cell.classList.add('shelf-cell');
                cell.id = `cell-${r}-${c}`;
                shelfGrid.appendChild(cell);
            }
            initializeShelfState();
            renderAll();
        });
        
        // ลบ Event Listener ของ 'storage' เก่าออก เพราะเราจะใช้ WebSocket แทน
        window.removeEventListener('storage', renderAll);
        
        // *** START: WebSocket Integration ***
        function setupWebSocket() {
            console.log("Attempting to connect to WebSocket at ws://localhost:8000/ws");
            const ws = new WebSocket("ws://localhost:8000/ws");

            ws.onopen = function(event) {
                console.log("✅ WebSocket connection established.");
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log("📩 Received message from server:", data);

                    switch (data.type) {
                        case "initial_state":
                            localStorage.setItem('shelfQueue', JSON.stringify(data.payload.jobs));
                            localStorage.setItem('globalShelfState', JSON.stringify(data.payload.shelf_state));
                            renderAll();
                            break;
                        case "new_job":
                            const queue = getQueue();
                            if (!queue.some(job => job.jobId === data.payload.jobId)) {
                                queue.push(data.payload);
                                localStorage.setItem('shelfQueue', JSON.stringify(queue));
                                renderAll();
                                showNotification(`New job added: ${data.payload.lot_no}`);
                            }
                            break;
                        case "job_completed":
                            let currentQueue = getQueue();
                            currentQueue = currentQueue.filter(j => j.jobId !== data.payload.completedJobId);
                            localStorage.setItem('shelfQueue', JSON.stringify(currentQueue));
                            localStorage.setItem('globalShelfState', JSON.stringify(data.payload.shelf_state));
                            localStorage.removeItem('activeShelfJob');
                            renderAll();
                            showNotification(`Job completed.`);
                            break;
                        case "job_error":
                            localStorage.setItem('activeShelfJob', JSON.stringify(data.payload));
                            renderAll();
                            showNotification(`Job error reported for Lot ${data.payload.lot_no}`, 'error');
                            break;
                        case "system_reset":
                            localStorage.clear();
                            initializeShelfState();
                            renderAll();
                            showNotification('System has been reset.', 'warning');
                            break;
                    }
                } catch (e) {
                    console.error("Error parsing message from server:", e);
                }
            };

            ws.onclose = function(event) {
                console.log("❌ WebSocket connection closed. Reconnecting in 3 seconds...");
                setTimeout(setupWebSocket, 3000); // ลองเชื่อมต่อใหม่
            };

            ws.onerror = function(error) {
                console.error("💥 WebSocket error:", error);
            };
        }
        
        // เริ่มการเชื่อมต่อ WebSocket หลังจากที่หน้าเว็บโหลดเสร็จ
        setupWebSocket();
        // *** END: WebSocket Integration ***

    </script>
</body>
</html>